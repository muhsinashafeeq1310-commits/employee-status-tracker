<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <title>Eman Bakery – Employee Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            emeraldDark: '#0F2027',
            emeraldGreen: '#28623A'
          },
          fontFamily: {
            sans: ['system-ui', 'sans-serif']
          }
        }
      }
    };
  </script>

  <!-- Supabase JS CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="h-full bg-emeraldDark text-slate-100 font-sans">
  <div id="appRoot" class="min-h-full flex flex-col items-center justify-center px-4 py-6">

    <!-- Login screen -->
    <div id="loginScreen" class="w-full max-w-sm">
      <div
        class="bg-gradient-to-b from-emeraldDark to-emeraldGreen rounded-3xl shadow-2xl border border-white/10 px-6 py-8 space-y-6">
        <div class="text-center space-y-1">
          <p class="text-xs uppercase tracking-[0.25em] text-slate-300">eman</p>
          <h1 class="text-2xl font-semibold tracking-wide">Eman Bakery</h1>
          <p class="text-xs text-slate-300 mt-1">Bank account onboarding status</p>
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-sm text-slate-200 mb-1">Email</label>
            <input id="emailInput" type="email"
              class="w-full bg-black/30 border border-white/10 rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emeraldGreen"
              placeholder="you@example.com" />
          </div>
          <div>
            <label class="block text-sm text-slate-200 mb-1">Password</label>
            <input id="passwordInput" type="password"
              class="w-full bg-black/30 border border-white/10 rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emeraldGreen"
              placeholder="••••••••" />
          </div>

          <button id="loginBtn"
            class="w-full mt-2 bg-emeraldGreen hover:bg-emeraldGreen/90 text-white text-sm font-medium py-2.5 rounded-2xl shadow-lg shadow-emeraldGreen/30 transition active:scale-[0.98]">
            Sign in
          </button>

          <p class="text-[11px] text-slate-300 text-center leading-snug mt-1">
            Login With Your User Name and Password.<br />
            <a href="https://www.emanbakeries.com" class="underline">www.emanbakeries.com</a>
          </p>
        </div>
      </div>
    </div>

    <!-- Main app screen -->
    <div id="mainScreen" class="hidden w-full max-w-3xl mx-auto">
      <!-- Top bar -->
      <div class="flex items-center justify-between mb-5">
        <div>
          <h2 class="text-xl font-semibold tracking-wide">Eman Bakery</h2>
          <p id="currentUserRole" class="text-xs text-slate-300 mt-0.5"></p>
        </div>
        <button id="logoutBtn"
          class="text-[11px] px-3 py-1.5 rounded-full border border-white/15 text-slate-200 bg-black/20 hover:bg-black/30">
          Log out
        </button>
      </div>

      <!-- Tabs -->
      <div class="flex gap-2 mb-4">
        <button id="tabEmployees"
          class="flex-1 text-center text-xs py-2 rounded-2xl bg-emeraldGreen text-white font-medium shadow-lg shadow-emeraldGreen/30">
          Employees
        </button>
        <button id="tabAdd"
          class="flex-1 text-center text-xs py-2 rounded-2xl bg-black/40 text-slate-200 border border-white/10">
          Add employee
        </button>
      </div>

      <!-- Employees list -->
      <div id="employeesView" class="space-y-3 overflow-y-auto max-h-[70vh] pb-6">
        <!-- Cards inserted here -->
      </div>

      <!-- Add employee form -->
      <div id="addView" class="hidden mt-1">
        <div
          class="bg-gradient-to-b from-emeraldDark to-emeraldGreen rounded-3xl shadow-2xl border border-white/10 px-4 py-4 space-y-3">
          <h3 class="text-sm font-semibold tracking-wide mb-1">New employee</h3>

          <div class="grid grid-cols-1 gap-3 text-xs">
            <div>
              <label class="block mb-1 text-slate-100">Name</label>
              <input id="newName" type="text"
                class="w-full bg-black/30 border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emeraldGreen">
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block mb-1 text-slate-100">ID number</label>
                <input id="newId" type="text"
                  class="w-full bg-black/30 border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emeraldGreen">
              </div>
              <div>
                <label class="block mb-1 text-slate-100">Mobile</label>
                <input id="newMobile" type="text"
                  class="w-full bg-black/30 border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emeraldGreen">
              </div>
            </div>
            <div>
              <label class="block mb-1 text-slate-100">IBAN</label>
              <input id="newIban" type="text"
                class="w-full bg-black/30 border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emeraldGreen">
            </div>
            <div>
              <label class="block mb-1 text-slate-100">Email</label>
              <input id="newEmail" type="email"
                class="w-full bg-black/30 border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emeraldGreen">
            </div>
          </div>

          <button id="saveEmployeeBtn"
            class="w-full mt-2 bg-black/40 hover:bg-black/50 text-sm font-medium py-2.5 rounded-2xl border border-white/15">
            Save employee
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Simple toast -->
  <div id="toast"
       class="fixed bottom-5 inset-x-0 mx-auto max-w-xs px-4 opacity-0 pointer-events-none transition">
    <div class="bg-black/80 text-xs text-slate-100 rounded-2xl px-4 py-2.5 text-center shadow-lg border border-white/10">
      <span id="toastMsg"></span>
    </div>
  </div>

  <script>
    // ==== Supabase client ====
    const SUPABASE_URL = 'https://ftkwyywgoutsvdcdvyja.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ0a3d5eXdnb3V0c3ZkY2R2eWphIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0Nzc2MjMsImV4cCI6MjA4NjA1MzYyM30.RgII5Z89N17xHU7CMqbvGtA1tdLkxJLqz2NVC_xo-SU';
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ==== Auth + app state ====
    let currentUser = null; // { id, email, role }
    let employees = [];     // local cache of employees

    // --- Utility: toast ---
    function showToast(message) {
      const toast = document.getElementById('toast');
      const msg = document.getElementById('toastMsg');
      msg.textContent = message;
      toast.classList.remove('opacity-0');
      toast.classList.add('opacity-100');
      setTimeout(() => {
        toast.classList.remove('opacity-100');
        toast.classList.add('opacity-0');
      }, 2000);
    }

    // === Fetch user role from user_roles ===
    async function fetchUserRole(userId) {
      const { data, error } = await supabaseClient
        .from('user_roles')
        .select('role')
        .eq('user_id', userId)
        .single();

      if (error) {
        console.error(error);
        showToast('No role found for this user');
        return null;
      }

      return data.role;
    }

    // === Fetch employees from Supabase ===
    async function fetchEmployees() {
      const { data, error } = await supabaseClient
        .from('employees')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) {
        console.error(error);
        showToast('Error loading employees');
        return;
      }

      employees = data.map(row => ({
        id: row.id,
        name: row.name,
        nationalId: row.identification_number,
        mobile: row.mobile,
        iban: row.iban,
        email: row.email,
        qiwa: row.qiwa_status,
        gosi: row.gosi_status,
        mudad: row.mudad_status
      }));

      renderEmployees();
    }

    // === Login / logout ===
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    loginBtn.addEventListener('click', async () => {
      const email = document.getElementById('emailInput').value.trim();
      const password = document.getElementById('passwordInput').value.trim();

      if (!email || !password) {
        showToast('Email and password required');
        return;
      }

      const { data, error } = await supabaseClient.auth.signInWithPassword({
        email,
        password
      });

      if (error) {
        console.error(error);
        showToast('Login failed');
        return;
      }

      const user = data.user;
      const role = await fetchUserRole(user.id);
      if (!role) {
        await supabaseClient.auth.signOut();
        return;
      }

      currentUser = { id: user.id, email: user.email, role };
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('mainScreen').classList.remove('hidden');
      document.getElementById('currentUserRole').textContent =
        `${user.email} – ${role === 'creator' ? 'Can add employees' : 'Can update statuses'}`;

      // Configure Add tab visibility for updater
      const tabAdd = document.getElementById('tabAdd');
      if (role === 'creator') {
        tabAdd.classList.remove('opacity-40', 'pointer-events-none');
      } else {
        tabAdd.classList.add('opacity-40', 'pointer-events-none');
        activateTab(true);
      }

      fetchEmployees();
    });

    logoutBtn.addEventListener('click', async () => {
      await supabaseClient.auth.signOut();
      currentUser = null;
      document.getElementById('emailInput').value = '';
      document.getElementById('passwordInput').value = '';
      document.getElementById('mainScreen').classList.add('hidden');
      document.getElementById('loginScreen').classList.remove('hidden');
    });

    // === Tabs ===
    const tabEmployees = document.getElementById('tabEmployees');
    const tabAdd = document.getElementById('tabAdd');
    const employeesView = document.getElementById('employeesView');
    const addView = document.getElementById('addView');

    function activateTab(isEmployees) {
      if (isEmployees) {
        tabEmployees.classList.add('bg-emeraldGreen', 'text-white', 'shadow-lg');
        tabEmployees.classList.remove('bg-black/40', 'border', 'border-white/10');
        tabAdd.classList.add('bg-black/40', 'border', 'border-white/10');
        tabAdd.classList.remove('bg-emeraldGreen', 'text-white', 'shadow-lg');
        employeesView.classList.remove('hidden');
        addView.classList.add('hidden');
      } else {
        tabAdd.classList.add('bg-emeraldGreen', 'text-white', 'shadow-lg');
        tabAdd.classList.remove('bg-black/40', 'border', 'border-white/10');
        tabEmployees.classList.add('bg-black/40', 'border', 'border-white/10');
        tabEmployees.classList.remove('bg-emeraldGreen', 'text-white', 'shadow-lg');
        employeesView.classList.add('hidden');
        addView.classList.remove('hidden');
      }
    }

    function switchToEmployees() { activateTab(true); }
    function switchToAdd() { activateTab(false); }

    tabEmployees.addEventListener('click', switchToEmployees);
    tabAdd.addEventListener('click', () => {
      if (currentUser?.role !== 'creator') return;
      switchToAdd();
    });

    activateTab(true); // default

    // === Add employee ===
    const saveEmployeeBtn = document.getElementById('saveEmployeeBtn');

    saveEmployeeBtn.addEventListener('click', async () => {
      if (currentUser?.role !== 'creator') {
        showToast('Only creator can add employees');
        return;
      }

      const name = document.getElementById('newName').value.trim();
      const nationalId = document.getElementById('newId').value.trim();
      const mobile = document.getElementById('newMobile').value.trim();
      const iban = document.getElementById('newIban').value.trim();
      const email = document.getElementById('newEmail').value.trim();

      if (!name || !nationalId || !iban) {
        showToast('Name, ID and IBAN are required');
        return;
      }

      const newEmpRow = {
        name,
        identification_number: nationalId,
        mobile,
        iban,
        email,
        qiwa_status: 'pending',
        gosi_status: 'pending',
        mudad_status: 'pending'
      };

      const { data, error } = await supabaseClient
        .from('employees')
        .insert(newEmpRow)
        .select()
        .single();

      if (error) {
        console.error(error);
        showToast('Error adding employee');
        return;
      }

      employees.unshift({
        id: data.id,
        name: data.name,
        nationalId: data.identification_number,
        mobile: data.mobile,
        iban: data.iban,
        email: data.email,
        qiwa: data.qiwa_status,
        gosi: data.gosi_status,
        mudad: data.mudad_status
      });

      renderEmployees();
      showToast('Employee added');

      document.getElementById('newName').value = '';
      document.getElementById('newId').value = '';
      document.getElementById('newMobile').value = '';
      document.getElementById('newIban').value = '';
      document.getElementById('newEmail').value = '';

      switchToEmployees();
    });

    // === Render employees ===
    function renderEmployees() {
      employeesView.innerHTML = '';

      if (employees.length === 0) {
        employeesView.innerHTML =
          '<p class="text-xs text-slate-300 text-center py-8">No employees yet. Use "Add employee" to create one.</p>';
        return;
      }

      employees.forEach(emp => {
        const card = document.createElement('div');
        card.className =
          'bg-gradient-to-b from-emeraldDark to-emeraldGreen rounded-3xl border border-white/10 shadow-xl px-4 py-3 space-y-2';

        const nameRow = document.createElement('div');
        nameRow.className = 'flex items-start justify-between gap-2';

        nameRow.innerHTML = `
          <div>
            <p class="text-sm font-semibold">${emp.name}</p>
            <p class="text-[11px] text-slate-200 mt-0.5">ID: ${emp.nationalId || '-'}</p>
            <p class="text-[11px] text-slate-200">Mobile: ${emp.mobile || '-'}</p>
            <p class="text-[11px] text-slate-200 truncate">IBAN: ${emp.iban || '-'}</p>
          </div>
        `;

        card.appendChild(nameRow);

        const statuses = document.createElement('div');
        statuses.className = 'grid grid-cols-3 gap-2 mt-2';

        ['qiwa', 'gosi', 'mudad'].forEach(key => {
          const value = emp[key];
          const isDone = value === 'done';
          const label = key.toUpperCase();

          const badge = document.createElement('div');
          badge.className =
            'flex flex-col items-center justify-between bg-black/30 rounded-2xl border border-white/10 px-2 py-2 text-[10px] text-center';

          const statusPill = `
            <span class="px-2 py-0.5 rounded-full text-[10px] ${isDone ? 'bg-emeraldGreen/90' : 'bg-slate-600/70'} text-white">
              ${isDone ? 'Done' : 'Pending'}
            </span>
          `;

          let actionBtn = '';
          if (currentUser?.role === 'updater') {
            actionBtn = `
              <button data-emp="${emp.id}" data-key="${key}"
                class="mt-1 px-2 py-0.5 rounded-full border border-white/20 text-[10px] bg-black/30 hover:bg-black/50">
                ${isDone ? 'Mark pending' : 'Mark done'}
              </button>
            `;
          }

          badge.innerHTML = `
            <span class="uppercase tracking-wide text-slate-200 mb-1">${label}</span>
            ${statusPill}
            ${actionBtn}
          `;

          statuses.appendChild(badge);
        });

        card.appendChild(statuses);
        employeesView.appendChild(card);
      });

      // Attach listeners for status buttons
      document.querySelectorAll('[data-emp]').forEach(btn => {
        btn.addEventListener('click', () => {
          const empId = Number(btn.getAttribute('data-emp'));
          const key = btn.getAttribute('data-key');
          handleStatusChange(empId, key);
        });
      });
    }

    // === Update status with confirmation ===
    async function handleStatusChange(empId, key) {
      if (currentUser?.role !== 'updater') {
        showToast('Only updater can change statuses');
        return;
      }

      const emp = employees.find(e => e.id === empId);
      if (!emp) return;

      const current = emp[key];
      const target = current === 'done' ? 'pending' : 'done';

      const confirmed = window.confirm(
        `Are you sure you want to change ${key.toUpperCase()} status for ${emp.name} from "${current}" to "${target}"?`
      );
      if (!confirmed) return;

      const columnMap = {
        qiwa: 'qiwa_status',
        gosi: 'gosi_status',
        mudad: 'mudad_status'
      };

      const { error } = await supabaseClient
        .from('employees')
        .update({ [columnMap[key]]: target })
        .eq('id', empId);

      if (error) {
        console.error(error);
        showToast('Error updating status');
        return;
      }

      emp[key] = target;
      renderEmployees();
      showToast(`${key.toUpperCase()} updated`);
    }
  </script>
</body>
</html>
