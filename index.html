<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
  />

  <!-- ANTI-CACHE HEADERS -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <title>E M A N – Employee Portal</title>

  <!-- iOS Native App Config -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Eman Bakery" />
  <meta name="theme-color" content="#132530" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <!-- For login + add screens -->
  <link
    href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@300;400;500;600&display=swap"
    rel="stylesheet"
  />
  <!-- For dashboard -->
  <link
    href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <!-- Icons -->
  <link
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
    rel="stylesheet"
  />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script id="tailwind-config">
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            /* Login + Add gradients */
            "soft-white": "#F8FAFC",
            "muted-grey": "#5C7C8A",
            "deep-teal": "#132530",
            "accent-blue": "#A0B0B9",

            /* Dashboard palette */
            primary: "#2563eb",
            accent: "#2563eb",
            "background-light": "#f9fafb",
            "surface-light": "#ffffff",
            "border-light": "#f1f5f9",
            "text-main": "#0f172a",
            "text-muted": "#64748b",

            /* Add-entry palette */
            "muted-blue": "#5C7C8A",
            "dark-slate": "#132530",
            "steel-blue": "#A0B0B9"
          },
          fontFamily: {
            serif: ['"Playfair Display"', "serif"],
            sans: ['"Inter"', "sans-serif"],
            display: ['"Plus Jakarta Sans"', "sans-serif"]
          },
          borderRadius: {
            executive: "35px"
          }
        }
      }
    };
  </script>

  <style type="text/tailwindcss">
    @layer base {
      body {
        @apply m-0 p-0 antialiased;
        font-family: theme("fontFamily.sans");
        background: linear-gradient(to bottom, #F8FAFC 0%, #5C7C8A 50%, #132530 100%);
        min-height: 100dvh;
        -webkit-tap-highlight-color: transparent;
      }
    }

    .hide-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .hide-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    /* LOGIN design */
    .texture-overlay {
      position: fixed;
      inset: 0;
      background-image: repeating-linear-gradient(
        90deg,
        rgba(0, 0, 0, 0.03) 0px,
        rgba(0, 0, 0, 0.03) 1px,
        transparent 1px,
        transparent 4px
      );
      pointer-events: none;
      z-index: 5;
    }
    .luxury-card {
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      border-radius: 40px;
    }
    .pill-input {
      @apply w-full bg-white/5 border border-white/10 rounded-full px-6 py-4 text-white focus:outline-none focus:ring-1 focus:ring-accent-blue/50 transition-all duration-300 placeholder:text-accent-blue/40 font-light tracking-wide;
    }
    .pill-button {
      @apply w-full rounded-full py-4 font-medium transition-all duration-300 flex items-center justify-center gap-2;
    }

    /* DASHBOARD glass nav */
    .glass-nav {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    /* ADD ENTRY design */
    .floating-card {
      @apply bg-white/10 backdrop-blur-xl border border-white/20 shadow-2xl rounded-executive p-8 mb-12 flex flex-col items-center text-center;
      transition: transform 0.3s ease;
    }
    .pill-container {
      @apply rounded-full border border-white/30 bg-white/5 px-6 py-4 w-full text-white placeholder-steel-blue/50 focus:outline-none focus:ring-1 focus:ring-white/40;
    }
    .btn-pill {
      @apply rounded-full px-8 py-4 font-medium transition-all duration-300 text-sm tracking-widest uppercase flex items-center justify-center gap-2;
    }

    /* Shared modal / loader / status */
    .modal-hidden {
      opacity: 0;
      pointer-events: none;
      transform: translateY(100%) scale(0.95);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .modal-visible {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0) scale(1);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .loader {
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-top: 2px solid #2563eb;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .tile-done {
      background: rgba(22, 163, 74, 0.15);
      border: 1px solid rgba(22, 163, 74, 0.4);
      color: #4ade80;
    }
    .tile-pending {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: #94a3b8;
    }

    body {
      min-height: max(884px, 100dvh);
    }
  </style>
</head>

<body class="min-h-screen flex flex-col overflow-x-hidden relative">

  <!-- GLOBAL LOADER -->
  <div
    id="globalLoader"
    class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-deep-teal"
  >
    <div class="loader w-10 h-10 border-4"></div>
    <p class="mt-4 text-xs font-bold tracking-widest text-soft-white/80 uppercase">
      Loading portal...
    </p>
  </div>

  <!-- ================= LOGIN SCREEN ================= -->
  <div
    id="loginScreen"
    class="flex-1 flex items-center justify-center p-6 relative"
  >
    <div class="texture-overlay"></div>

    <main class="relative z-10 w-full max-w-sm lg:max-w-md">
      <div class="luxury-card p-10 lg:p-14 flex flex-col items-center">
        <header class="text-center mb-12">
          <div class="mb-6 opacity-80">
            <span
              class="material-symbols-outlined text-accent-blue text-4xl font-extralight"
            >
              blur_on
            </span>
          </div>
          <h1
            class="font-serif text-5xl lg:text-6xl text-soft-white tracking-widest mb-3"
          >
            E M A N
          </h1>
          <p
            class="font-sans text-[10px] uppercase tracking-[0.4em] text-accent-blue font-medium"
          >
            Bakery Employee Portal
          </p>
        </header>

        <form class="w-full space-y-6" onsubmit="return false;">
          <div class="space-y-1.5">
            <div class="relative">
              <input
                id="emailInput"
                type="email"
                class="pill-input uppercase text-[11px] tracking-widest"
                placeholder="EMPLOYEE EMAIL"
                autocomplete="username"
              />
            </div>
          </div>
          <div class="space-y-1.5">
            <div class="relative">
              <input
                id="passwordInput"
                type="password"
                class="pill-input uppercase text-[11px] tracking-widest"
                placeholder="PASSWORD"
                autocomplete="current-password"
              />
            </div>
          </div>

          <div class="pt-4 space-y-4">
            <button
              id="loginBtn"
              type="button"
              class="pill-button bg-soft-white text-deep-teal hover:bg-accent-blue hover:text-white active:scale-95"
            >
              <span class="text-xs uppercase tracking-widest font-semibold">
                Sign In
              </span>
            </button>

            <div class="flex items-center gap-4 py-2">
              <div class="h-[1px] bg-white/5 flex-1"></div>
              <span
                class="text-[9px] text-accent-blue/50 uppercase tracking-widest"
              >
                Biometric
              </span>
              <div class="h-[1px] bg-white/5 flex-1"></div>
            </div>

            <button
              type="button"
              class="pill-button border border-accent-blue/30 text-accent-blue hover:bg-white/5"
            >
              <span class="material-symbols-outlined text-[20px]">face_6</span>
              <span class="text-xs uppercase tracking-widest">Face ID</span>
            </button>
          </div>
        </form>

        <div class="mt-8">
          <button
            type="button"
            class="text-[10px] text-accent-blue/60 hover:text-accent-blue uppercase tracking-widest transition-colors"
          >
            Access Recovery
          </button>
        </div>

        <footer class="mt-16 pt-8 border-t border-white/5 w-full text-center">
          <button
            type="button"
            onclick="window.location.reload(true)"
            class="text-[10px] text-accent-blue uppercase tracking-[0.3em] font-medium hover:brightness-125 transition-all"
          >
            Check for Updates
          </button>
          <div
            class="mt-4 text-[9px] text-accent-blue/30 tracking-widest font-light"
          >
            BUILD v2.4.0 • SECURED
          </div>
        </footer>
      </div>
    </main>
  </div>

  <!-- ================= MAIN DASHBOARD ================= -->
  <div
    id="mainScreen"
    class="hidden min-h-screen flex flex-col overflow-hidden relative bg-background-light font-display text-text-main"
  >
    <!-- HEADER -->
    <header
      class="flex items-center justify-between px-6 pt-14 pb-6 sticky top-0 z-30 bg-background-light/80 backdrop-blur-md"
    >
      <div class="flex items-center gap-4">
        <div class="relative group">
          <!-- avatar is neutral: can be updated later -->
          <div
            class="h-11 w-11 rounded-full bg-gradient-to-br from-slate-700 to-slate-500 border border-gray-100 shadow-sm flex items-center justify-center text-xs font-bold text-white uppercase"
            id="headerAvatar"
          >
            EM
          </div>
          <div
            class="absolute -bottom-0.5 -right-0.5 h-3.5 w-3.5 rounded-full bg-emerald-500 border-2 border-white"
          ></div>
        </div>
        <div>
          <h1
            class="text-[11px] font-bold text-accent uppercase tracking-wider mb-0.5"
          >
            Welcome back
          </h1>
          <p
            id="currentUserDisplay"
            class="text-xl font-bold text-text-main tracking-tight truncate max-w-[180px]"
          >
            Employee
          </p>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button
          type="button"
          class="relative p-2.5 rounded-full bg-white border border-border-light shadow-sm transition-all duration-200 active:bg-gray-50"
        >
          <span class="material-symbols-outlined text-[22px] text-text-muted">
            notifications
          </span>
          <span
            class="absolute top-2.5 right-2.5 h-2 w-2 rounded-full bg-accent ring-2 ring-white"
          ></span>
        </button>
        <button
          id="logoutBtn"
          type="button"
          class="p-2.5 rounded-full bg-white border border-border-light shadow-sm transition-all duration-200 active:bg-gray-50"
        >
          <span class="material-symbols-outlined text-[20px] text-rose-500">
            logout
          </span>
        </button>
      </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-1 overflow-y-auto hide-scrollbar pb-32">
      <!-- Status bar (role + count) -->
      <div class="px-6 pt-4 mb-4 flex items-center justify-between">
        <div
          class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-white border border-border-light shadow-sm"
        >
          <span class="h-1.5 w-1.5 rounded-full bg-emerald-500"></span>
          <span
            id="roleBadge"
            class="text-[10px] font-bold text-text-muted uppercase tracking-[0.16em]"
          >
            Role
          </span>
        </div>
        <span
          id="empCount"
          class="text-[10px] font-bold text-accent bg-accent/10 px-2 py-1 rounded-full tracking-widest uppercase"
        >
          0 Files
        </span>
      </div>

      <!-- Branch / context selector -->
      <div class="px-6 mb-10">
        <div class="relative">
          <select
            class="w-full appearance-none bg-white border border-border-light rounded-xl py-3.5 pl-4 pr-10 text-[14px] font-semibold text-text-main focus:ring-2 focus:ring-accent/10 focus:border-accent transition-all duration-300 shadow-sm"
          >
            <option>Employee Registry – Qiwa / Gosi / Mudad</option>
          </select>
          <div
            class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-text-muted"
          >
            <span class="material-symbols-outlined text-lg">unfold_more</span>
          </div>
        </div>
      </div>

      <!-- QUICK ACTIONS -->
      <div class="px-6 mb-12">
        <h2
          class="text-xs font-bold text-text-muted uppercase tracking-[0.1em] mb-6"
        >
          Quick Actions
        </h2>

        <div class="flex flex-col gap-5">
          <!-- Add New Entry (visual only) -->
          <button
            type="button"
            class="flex items-center justify-between group p-1 -ml-1"
          >
            <div class="flex items-center gap-4">
              <div
                class="h-10 w-10 flex items-center justify-center rounded-full bg-accent text-white transition-transform duration-300 group-active:scale-90"
              >
                <span class="material-symbols-outlined">add</span>
              </div>
              <div class="text-left">
                <p class="text-base font-bold text-text-main leading-tight">
                  Add New Entry
                </p>
                <p class="text-xs text-text-muted font-medium mt-0.5">
                  Log inventory or sales
                </p>
              </div>
            </div>
            <span
              class="material-symbols-outlined text-gray-300 group-hover:text-accent transition-colors"
              >arrow_forward_ios</span
            >
          </button>

          <div class="h-[1px] bg-border-light w-full"></div>

          <div class="grid grid-cols-2 gap-8">
            <!-- Report (refresh list) -->
            <button
              type="button"
              onclick="window.fetchEmployees && window.fetchEmployees()"
              class="flex items-center gap-3 group"
            >
              <div
                class="h-8 w-8 flex items-center justify-center rounded-lg bg-gray-100 text-text-muted group-hover:bg-accent/10 group-hover:text-accent transition-all"
              >
                <span class="material-symbols-outlined text-[20px]"
                  >analytics</span
                >
              </div>
              <div class="text-left">
                <p
                  class="text-[14px] font-bold text-text-main group-hover:text-accent transition-colors"
                >
                  Report
                </p>
                <p class="text-[11px] text-text-muted">Refresh & view stats</p>
              </div>
            </button>

            <!-- Add Staff (opens add overlay; enabled only for creators) -->
            <button
              id="btnOpenAdd"
              type="button"
              class="flex items-center gap-3 group opacity-40 pointer-events-none"
            >
              <div
                class="h-8 w-8 flex items-center justify-center rounded-lg bg-gray-100 text-text-muted group-hover:bg-accent/10 group-hover:text-accent transition-all"
              >
                <span class="material-symbols-outlined text-[20px]"
                  >person_add</span
                >
              </div>
              <div class="text-left">
                <p
                  class="text-[14px] font-bold text-text-main group-hover:text-accent transition-colors"
                >
                  Add Staff
                </p>
                <p class="text-[11px] text-text-muted">Onboard employee</p>
              </div>
            </button>
          </div>
        </div>
      </div>

      <!-- EMPLOYEE DIRECTORY -->
      <div class="px-6 mb-12">
        <div class="flex items-center justify-between mb-4">
          <h2
            class="text-xs font-bold text-text-muted uppercase tracking-[0.1em]"
          >
            Employee Files
          </h2>
          <span class="text-[11px] text-text-muted">
            Tap a card to see details
          </span>
        </div>
        <div
          id="employeesView"
          class="grid grid-cols-1 md:grid-cols-3 gap-4"
        >
          <!-- Cards injected here -->
        </div>
      </div>

      <!-- RECENT ACTIVITY -->
      <div class="px-6 pb-8">
        <div class="flex items-center justify-between mb-6">
          <h2
            class="text-xs font-bold text-text-muted uppercase tracking-[0.1em]"
          >
            Recent Activity
          </h2>
          <button
            type="button"
            class="text-[11px] font-bold text-accent hover:underline decoration-2 underline-offset-4 tracking-wide uppercase"
          >
            View All
          </button>
        </div>
        <div id="activityLogView" class="space-y-8">
          <!-- Logs injected here -->
        </div>
      </div>
    </main>

    <!-- BOTTOM NAV -->
    <div
      class="fixed bottom-0 left-0 right-0 glass-nav border-t border-border-light pb-8 pt-4 px-8 z-50"
    >
      <nav class="flex justify-between items-center max-w-lg mx-auto">
        <button
          type="button"
          class="flex flex-col items-center gap-1.5 text-accent transition-all group"
        >
          <span
            class="material-symbols-outlined text-[26px] transition-transform group-active:scale-110"
            style="font-variation-settings: 'FILL' 1"
            >dashboard</span
          >
          <span class="text-[10px] font-bold uppercase tracking-widest"
            >Home</span
          >
        </button>
        <button
          type="button"
          class="flex flex-col items-center gap-1.5 text-text-muted hover:text-text-main transition-all group"
        >
          <span
            class="material-symbols-outlined text-[26px] transition-transform group-active:scale-110"
            >calendar_month</span
          >
          <span class="text-[10px] font-bold uppercase tracking-widest"
            >Schedule</span
          >
        </button>
        <div class="relative -top-8">
          <button
            type="button"
            onclick="window.fetchEmployees && window.fetchEmployees()"
            class="h-16 w-16 rounded-full bg-text-main text-white shadow-xl shadow-slate-200 flex items-center justify-center transition-all duration-300 active:scale-90 active:shadow-md"
          >
            <span class="material-symbols-outlined text-[30px]"
              >qr_code_scanner</span
            >
          </button>
        </div>
        <button
          type="button"
          class="flex flex-col items-center gap-1.5 text-text-muted hover:text-text-main transition-all group"
        >
          <span
            class="material-symbols-outlined text-[26px] transition-transform group-active:scale-110"
            >inventory</span
          >
          <span class="text-[10px] font-bold uppercase tracking-widest"
            >Stock</span
          >
        </button>
        <button
          type="button"
          class="flex flex-col items-center gap-1.5 text-text-muted hover:text-text-main transition-all group"
        >
          <span
            class="material-symbols-outlined text-[26px] transition-transform group-active:scale-110"
            >settings</span
          >
          <span class="text-[10px] font-bold uppercase tracking-widest"
            >Settings</span
          >
        </button>
      </nav>
    </div>
  </div>

  <!-- ================= DETAIL MODAL ================= -->
  <div
    id="detailModal"
    class="fixed inset-0 z-[60] flex items-end sm:items-center justify-center modal-hidden"
  >
    <div
      class="absolute inset-0 bg-black/60 backdrop-blur-sm"
      onclick="window.closeDetailModal && window.closeDetailModal()"
    ></div>
    <div
      id="detailContent"
      class="bg-dark-slate w-full max-w-lg p-6 rounded-t-2xl sm:rounded-2xl border border-white/10 relative z-10 mx-auto max-h-[90vh] overflow-y-auto text-white"
    >
      <div class="flex justify-center mb-6">
        <div class="w-12 h-1.5 bg-white/20 rounded-full"></div>
      </div>
      <div id="modalBody" class="space-y-6">
        <!-- Injected -->
      </div>
      <button
        type="button"
        onclick="window.closeDetailModal && window.closeDetailModal()"
        class="w-full mt-8 py-3.5 bg-white/5 text-white/70 font-bold rounded-xl uppercase tracking-widest text-xs hover:bg-white/10 transition-colors"
      >
        Close
      </button>
    </div>
  </div>

  <!-- ================= ADD ENTRY / ADD EMPLOYEE (CARD SELECTION) ================= -->
  <div
    id="addScreen"
    class="fixed inset-0 z-50 bg-background-dark/95 flex flex-col modal-hidden"
  >
    <!-- Header -->
    <header
      class="flex items-center justify-between px-4 py-3 bg-surface-dark/90 border-b border-white/10 backdrop-blur-md"
    >
      <button
        id="btnCloseAdd"
        type="button"
        class="p-2 text-gray-400 hover:text-white transition-colors"
      >
        <span class="material-symbols-outlined">close</span>
      </button>
      <span class="font-serif italic text-soft-white text-lg">
        Guided Journaling
      </span>
      <div class="w-8"></div>
    </header>

    <!-- Content -->
    <main class="flex-1 px-4 py-6 space-y-6 overflow-y-auto hide-scrollbar">
      <!-- Executive Role / Selected employee -->
      <section class="max-w-md mx-auto">
        <div
          id="execCard"
          class="relative rounded-3xl bg-surface-light/5 backdrop-blur-xl border border-white/10 shadow-2xl px-6 py-6 flex flex-col items-center text-center transform translate-y-4 opacity-0 scale-95 transition-all duration-500 ease-out"
        >
          <p class="text-[11px] tracking-[0.25em] uppercase text-steel-blue mb-2">
            Executive Role
          </p>
          <h2
            id="selectedNameLabel"
            class="text-xl font-semibold text-soft-white tracking-tight mb-1"
          >
            Tap an employee card below
          </h2>
          <p
            id="selectedIdLabel"
            class="text-[11px] text-steel-blue/80 tracking-[0.2em] uppercase"
          >
            ID will appear here
          </p>

          <div class="mt-4 flex items-center gap-3">
            <div
              id="selectedAvatar"
              class="h-10 w-10 rounded-full bg-gradient-to-br from-slate-700 to-slate-500 flex items-center justify-center text-xs font-bold text-white uppercase"
            >
              --
            </div>
            <span class="text-[11px] text-steel-blue/80 uppercase tracking-[0.16em]">
              Remaining employees
            </span>
          </div>
        </div>
      </section>

      <!-- Employee selection cards -->
      <section class="max-w-3xl mx-auto">
        <p class="text-[11px] font-semibold text-steel-blue/90 uppercase tracking-[0.18em] mb-3 text-center">
          Choose employee to onboard
        </p>
        <div
          id="pendingGrid"
          class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 justify-items-center"
        >
          <!-- Cards injected by JS -->
        </div>
      </section>

      <!-- Details (ID + contact / bank) -->
      <section class="max-w-md mx-auto w-full">
        <h3 class="block text-sm font-semibold text-soft-white mb-3 ml-1">
          File details (auto from selection)
        </h3>
        <div class="space-y-3">
          <input
            id="newId"
            type="text"
            placeholder="National ID (auto-filled)"
            class="w-full bg-black/20 border border-white/10 rounded-xl px-4 py-4 text-white/60 text-sm"
            readonly
          />
          <input
            id="newMobile"
            type="tel"
            placeholder="Mobile Number"
            class="w-full bg-surface-dark border border-white/10 rounded-xl px-4 py-4 text-white focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all text-sm"
          />
          <input
            id="newEmail"
            type="email"
            placeholder="Email Address"
            class="w-full bg-surface-dark border border-white/10 rounded-xl px-4 py-4 text-white focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all text-sm"
          />
          <input
            id="newIban"
            type="text"
            placeholder="IBAN"
            class="w-full bg-surface-dark border border-white/10 rounded-xl px-4 py-4 text-white focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all text-sm"
          />
        </div>
        <p class="mt-3 text-[11px] text-steel-blue/80 tracking-wide">
          These fields are filled when you tap an employee card. You can edit
          mobile, email or IBAN before saving if needed.
        </p>
      </section>
    </main>

    <!-- Footer Action -->
    <div class="p-4 bg-surface-dark/95 border-t border-white/10 pb-safe-bottom">
      <button
        id="saveEmployeeBtn"
        type="button"
        class="flex w-full items-center justify-center gap-2 rounded-xl bg-primary px-3 py-4 text-sm font-bold text-white shadow-lg active:scale-95 transition-all"
      >
        <span>Confirm &amp; Submit</span>
        <span class="material-symbols-outlined text-[20px]">check_circle</span>
      </button>
    </div>
  </div>

  <!-- CONFIRM MODAL -->
  <div
    id="confirmModal"
    class="fixed inset-0 z-[70] flex items-end sm:items-center justify-center modal-hidden"
  >
    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm"></div>
    <div
      class="bg-dark-slate w-full max-w-sm p-6 rounded-t-2xl sm:rounded-2xl border border-white/10 relative z-10 mx-4 mb-6"
    >
      <h3
        id="modalTitle"
        class="text-xl font-bold text-white mb-2"
      >
        Confirm
      </h3>
      <p
        id="modalText"
        class="text-sm text-steel-blue mb-6"
      >
        Are you sure?
      </p>
      <div class="flex gap-3">
        <button
          id="modalCancel"
          type="button"
          class="flex-1 py-3 rounded-xl bg-white/5 hover:bg-white/10 text-white font-bold text-sm"
        >
          Cancel
        </button>
        <button
          id="modalConfirm"
          type="button"
          class="flex-1 py-3 rounded-xl bg-soft-white text-dark-slate font-bold text-sm shadow-lg hover:bg-accent-blue hover:text-white transition-colors"
        >
          Confirm
        </button>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div
    id="toast"
    class="fixed top-12 left-1/2 -translate-x-1/2 z-[80] modal-hidden"
  >
    <div
      class="bg-dark-slate border border-accent-blue/50 text-soft-white font-bold px-6 py-3 rounded-full shadow-2xl flex items-center gap-2"
    >
      <span class="material-symbols-outlined text-accent-blue text-sm"
        >info</span
      >
      <span id="toastMsg" class="text-xs tracking-wide">Notification</span>
    </div>
  </div>

  <!-- APP LOGIC + SUPABASE -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const SUPABASE_URL = "https://ftkwyywgoutsvdcdvyja.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ0a3d5eXdnb3V0c3ZkY2R2eWphIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0Nzc2MjMsImV4cCI6MjA4NjA1MzYyM30.RgII5Z89N17xHU7CMqbvGtA1tdLkxJLqz2NVC_xo-SU";

    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Pre-loaded employees (35 already used in your app)
    const PRE_EMPLOYEES = [
      { name: "NAHEEMUDHEEN PARATHODI", id: "2235923253", mobile: "0552821842", iban: "SA6345000000852160290001", email: "naheemptd@emanbakeries.com" },
      { name: "SHAMSUDHEEN MANATTU", id: "2307985529", mobile: "0554658796", iban: "SA54658796543500000023340110001", email: "shamsumanat9890@gmail.com" },
      { name: "IBRAHIM BADUSHAN THOTTATHIKUDIYI", id: "2331355376", mobile: "0532001228", iban: "SA1745000000262432735001", email: "badushai803@gmail.com" },
      { name: "ALFAS ASLAM", id: "2503874980", mobile: "0540407512", iban: "SA40407512424500000023340524001", email: "alfasaslu7@gmail.com" },
      { name: "MUHAMMED SHALI VAZHAYIL", id: "2455820023", mobile: "0540357284", iban: "SA614500000023340532001", email: "salivazhayil@gmail.com" },
      { name: "SHERIN KOCHUKONICKAL AZEEZ", id: "2354488948", mobile: "0546311750", iban: "SA814500000023340714001", email: "kasherin384@gmail.com" },
      { name: "SHIJAS KAREEM PALLIMUKIL", id: "2256400710", mobile: "0557679177", iban: "SA034500000023340722001", email: "pkshijas556@gmail.com" },
      { name: "SINEESH PATHUKUDI MUHAMMED", id: "2440029813", mobile: "0546344301", iban: "SA224500000023340730001", email: "akkuansal72@gmail.com" },
      { name: "MUHAMMED PARAKKUNNATHU EBRAHIM", id: "2377814138", mobile: "0567278143", iban: "SA894500000023340748001", email: "foumalmammu@gmail.com" },
      { name: "ASINSHA ASAINAR VELLIRIPPIL", id: "2478222298", mobile: "0541537246", iban: "SA204500000023341449001", email: "asinshaasi@gmail.com" },
      { name: "CHEVU NISSAR MUTTATHUCHALIL MOIDU", id: "2309399752", mobile: "0545214900", iban: "SA734500000023341456001", email: "fasilchevunissar@gmail.com" },
      { name: "SUMANDAS SUKHANDU BIKASH", id: "2205956697", mobile: "0573106917", iban: "SA024500000023342488001", email: "sumonchaudary0012@gmail.com" },
      { name: "SHABEER ALI PANAKKATHODEN", id: "2481393557", mobile: "0548796167", iban: "SA804500000023341316001", email: "shabirp313@gmail.com" },
      { name: "AHAMMED KABEER VANKALATH", id: "2311162198", mobile: "0560413288", iban: "SA024500000023341324001", email: "ahammadkhabeer@gmail.com" },
      { name: "MUHSIN KURUTTUKAVIL MUSTHAFA", id: "2501103358", mobile: "0542677218", iban: "SA444500000023341357001", email: "muhsinkrtkvl17@gmail.com" },
      { name: "ASHKAR ENJAKUDIYIL ALI", id: "2501925479", mobile: "0561504608", iban: "SA794500000023341530001", email: "ashkarali1232@gmail.com" },
      { name: "ASHRAF MOONNAN KANDATHIL KOMU", id: "2311479220", mobile: "0559151648", iban: "SA714500000023341399001", email: "asharafbapu4@gmail.com" },
      { name: "ABDUSSAMAD PANDALAN", id: "2308915301", mobile: "0581341225", iban: "SA214500000023341720001", email: "samadthelakkad@gmail.com" },
      { name: "MUSTHAFA PATHAYAPURAKKAL", id: "2322180403", mobile: "0577343723", iban: "SA124500000023341415001", email: "m95042906@gmail.com" },
      { name: "ARIF KOORIMANNIL POOVATHIKKAL", id: "2453005585", mobile: "0580876240", iban: "SA6345000000262434046001", email: "sinansilu382@gmail.com" },
      { name: "RIYAS KILIVAYIL ALAVIKUTTY KILIVAYIL", id: "2303530915", mobile: "0560438943", iban: "SA6745000000221675051001", email: "riyasvga786786@gmail.com" },
      { name: "MANSOORALI MANSOORALI PUTHAN", id: "2405299500", mobile: "0546238774", iban: "SA054500000023341555001", email: "mansooreman4@gmail.com" },
      { name: "KONTHALAM THELLIKKUNNEL ABDUL AZEES", id: "2366253124", mobile: "0566770269", iban: "SA124500000023341803001", email: "konthalamazees3806@gmail.com" },
      { name: "RIFAS KANJIRAKKATTU KUDIYIL BASHEER", id: "2501103424", mobile: "0547522498", iban: "SA0445000000221672819001", email: "rifaskbasheer@gmail.com" },
      { name: "AGHIL ALIYAKKOTT GANGADHARAN", id: "2439707783", mobile: "0562692551", iban: "SA9345000000221672785001", email: "vishnuaghil67@gmail.com" },
      { name: "ABDUL AZEEZ AYIMPADI", id: "2289306652", mobile: "0567538526", iban: "SA104500000023341746001", email: "azeeseman123@gmail.com" },
      { name: "SHAMSUDHEEN KURUTTUKAVIL SAINUDHEEN", id: "2511077311", mobile: "0560531091", iban: "SA824500000023341761001", email: "shamslabba786@gmail.com" },
      { name: "JISHNU RAVEENDRAN", id: "2485790337", mobile: "0566304691", iban: "SA5345000000221673197001", email: "jishnur8089@gmail.com" },
      { name: "ANSAL RASAK", id: "2477053272", mobile: "0561569020", iban: "SA6445000000221673171001", email: "ansalrasak408@gmail.com" },
      { name: "SABEER KADOOKUNNAN KUNHIMOHAMED", id: "2308393285", mobile: "0503762558", iban: "SA214500000023342108001", email: "shifashifinkk@gmail.com" },
      { name: "KABEER POOVATHUM CHOTTIL MUHAMMED", id: "2245613761", mobile: "0545984250", iban: "SA094500000023342348001", email: "safvankabeer007@gmail.com" },
      { name: "EBRAHIM LATHEEF KAVANA PARAMBIL", id: "2309489785", mobile: "0567642933", iban: "SA134500000023342462001", email: "latheef20k5@gmail.com" },
      { name: "ABDUL MANAF KURUTTAKAVIL MUSTHAFA", id: "2301750994", mobile: "0560247459", iban: "SA494500000023343197001", email: "manafmusthafa3@gmail.com" },
      { name: "NEJMUDHEEN SAKHIB", id: "2481486153", mobile: "0568357829", iban: "SA444500000023344849001", email: "nejmudheensakhib786@gmail.com" },
      { name: "ABDUL MUNIR VAZHAYIL", id: "2289427870", mobile: "0593395106", iban: "SA284500000023343908001", email: "muneervazhayil78@gmail.com" }
    ];

    // Remaining 11 employees that should appear as selectable cards
    const REMAINING_EMPLOYEES = [
      {
        name: "Sidhik Kuruttukavil Kochu Muhammed",
        id: "2289943199",
        mobile: "",
        email: "",
        iban: ""
      },
      {
        name: "Abdul Jabbar Mannakuzhi Maithen",
        id: "2329326967",
        mobile: "",
        email: "",
        iban: ""
      },
      {
        name: "Anvar Husain Mohammed Anchukandan",
        id: "2345158345",
        mobile: "",
        email: "",
        iban: ""
      },
      {
        name: "Mohamed Safwan M Sally",
        id: "2347675510",
        mobile: "",
        email: "",
        iban: ""
      },
      {
        name: "Muhammed Rafi Aliparambil",
        id: "2354265015",
        mobile: "",
        email: "",
        iban: ""
      },
      {
        name: "Sulfi Puthiyedathu Basheer",
        id: "2376846297",
        mobile: "",
        email: "",
        iban: ""
      },
      {
        name: "Sabeeb Manat Hassan Kutty",
        id: "2455539706",
        mobile: "",
        email: "",
        iban: ""
      },
      {
        name: "Al Ameen Kadukkunnan",
        id: "2485790295",
        mobile: "",
        email: "",
        iban: ""
      },
      {
        name: "Ansif Ali Kuruttukavil Alikunju",
        id: "2501924977",
        mobile: "",
        email: "",
        iban: ""
      },
      {
        name: "Md Akter Hosen",
        id: "2515498364",
        mobile: "",
        email: "",
        iban: ""
      },
      {
        name: "Mobarok Hossen",
        id: "2552187540",
        mobile: "",
        email: "",
        iban: ""
      }
    ];

    let currentUser = null;
    let employees = [];
    let selectedPendingEmployee = null;

    const loginScreen = document.getElementById("loginScreen");
    const mainScreen = document.getElementById("mainScreen");
    const addScreen = document.getElementById("addScreen");

    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const saveEmployeeBtn = document.getElementById("saveEmployeeBtn");
    const btnOpenAdd = document.getElementById("btnOpenAdd");
    const btnCloseAdd = document.getElementById("btnCloseAdd");

    const employeesView = document.getElementById("employeesView");
    const activityLogView = document.getElementById("activityLogView");

    const roleBadge = document.getElementById("roleBadge");
    const empCount = document.getElementById("empCount");
    const currentUserDisplay = document.getElementById("currentUserDisplay");
    const headerAvatar = document.getElementById("headerAvatar");

    const globalLoader = document.getElementById("globalLoader");

    // Utilities
    function showToast(msg) {
      const t = document.getElementById("toast");
      document.getElementById("toastMsg").textContent = msg;
      t.classList.remove("modal-hidden");
      t.classList.add("modal-visible");
      setTimeout(() => {
        t.classList.remove("modal-visible");
        t.classList.add("modal-hidden");
      }, 2500);
    }

    function askConfirmation(title, text, cb) {
      const m = document.getElementById("confirmModal");
      document.getElementById("modalTitle").textContent = title;
      document.getElementById("modalText").textContent = text;
      m.classList.remove("modal-hidden");
      m.classList.add("modal-visible");

      const confirmBtn = document.getElementById("modalConfirm");
      const cancelBtn = document.getElementById("modalCancel");

      const clean = () => {
        m.classList.remove("modal-visible");
        m.classList.add("modal-hidden");
        confirmBtn.onclick = null;
        cancelBtn.onclick = null;
      };

      confirmBtn.onclick = async () => {
        try {
          await cb();
        } finally {
          clean();
        }
      };
      cancelBtn.onclick = clean;
    }

    // Detail modal helpers
    function renderDetailRow(label, value) {
      return `
        <div class="bg-black/20 p-3 rounded-xl border border-white/5 flex justify-between items-center group">
          <div class="overflow-hidden">
            <p class="text-[9px] font-bold text-steel-blue uppercase tracking-wider mb-0.5">${label}</p>
            <p class="text-sm font-bold text-soft-white truncate pr-2 select-all">${value}</p>
          </div>
          <button onclick="window.copyToClipboard && window.copyToClipboard('${value.replace(/'/g, "\\'")}')" class="p-2 text-steel-blue hover:text-white transition-colors">
            <span class="material-symbols-outlined text-[18px]">content_copy</span>
          </button>
        </div>
      `;
    }

    function renderStatusTile(emp, key) {
      const done = emp[`${key}_status`] === "done";
      const canUpdate = currentUser && currentUser.role === "updater";

      return `
        <div
          class="flex flex-col items-center justify-center p-3 rounded-xl border transition-all ${
            canUpdate ? "cursor-pointer active:scale-95 hover:border-accent/60" : ""
          } ${done ? "tile-done" : "tile-pending"}"
          ${canUpdate ? `onclick="window.toggleStatus && window.toggleStatus('${emp.id}','${key}','${emp.name.replace(/'/g, "\\'")}')"` : ""}
        >
          <span class="text-[9px] font-bold uppercase mb-1 tracking-wider opacity-70">${key}</span>
          <span class="material-symbols-outlined text-xl">
            ${done ? "check_circle" : "pending"}
          </span>
        </div>
      `;
    }

    // Global helpers on window for inline handlers
    window.copyToClipboard = (text) => {
      if (!text || text === "N/A") return;
      navigator.clipboard.writeText(text);
      showToast("Copied");
    };

    window.openDetailModal = (id) => {
      const emp = employees.find((e) => String(e.id) === String(id));
      if (!emp) return;

      const body = document.getElementById("modalBody");
      body.innerHTML = `
        <div>
          <h2 class="text-2xl font-bold text-white leading-tight">${emp.name}</h2>
          <p class="text-xs font-bold text-steel-blue mt-1 uppercase tracking-widest">
            ID: ${emp.identification_number || ""}
          </p>
        </div>

        <div class="space-y-3">
          ${renderDetailRow("Mobile", emp.mobile || "N/A")}
          ${renderDetailRow("Email", emp.email || "N/A")}
          ${renderDetailRow("IBAN", emp.iban || "N/A")}
        </div>

        <div class="grid grid-cols-3 gap-2 pt-4">
          <p class="col-span-3 text-[10px] font-black uppercase text-steel-blue mb-1">
            Status Files
          </p>
          ${["qiwa", "gosi", "mudad"].map((k) => renderStatusTile(emp, k)).join("")}
        </div>
      `;

      const modal = document.getElementById("detailModal");
      modal.classList.remove("modal-hidden");
      modal.classList.add("modal-visible");
    };

    window.closeDetailModal = () => {
      const modal = document.getElementById("detailModal");
      modal.classList.remove("modal-visible");
      modal.classList.add("modal-hidden");
    };

    window.toggleStatus = (id, key, name) => {
      const emp = employees.find((e) => String(e.id) === String(id));
      if (!emp) return;
      const current = emp[`${key}_status`] || "pending";
      const next = current === "done" ? "pending" : "done";

      askConfirmation(
        "Update Status",
        `Change ${key.toUpperCase()} for ${name} to ${next.toUpperCase()}?`,
        async () => {
          const { error } = await supabaseClient
            .from("employees")
            .update({ [`${key}_status`]: next })
            .eq("id", id);
          if (error) {
            showToast("Update failed");
            return;
          }
          await supabaseClient.from("activity_logs").insert({
            user_email: currentUser.email,
            action_type: "UPDATED",
            message: `${key.toUpperCase()} for ${name} -> ${next}`
          });
          await fetchEmployees();
          window.closeDetailModal();
          showToast("Status updated");
        }
      );
    };

    // Helpers for pending cards
    function initialsFromName(name) {
      return name
        .split(" ")
        .filter(Boolean)
        .map((p) => p[0])
        .join("")
        .slice(0, 2)
        .toUpperCase();
    }

    function renderPendingCards() {
      const grid = document.getElementById("pendingGrid");
      if (!grid) return;

      if (!REMAINING_EMPLOYEES.length) {
        grid.innerHTML =
          '<div class="col-span-3 text-center text-steel-blue/80 text-sm py-8">No remaining employees configured.</div>';
        return;
      }

      grid.innerHTML = REMAINING_EMPLOYEES.map((emp, idx) => {
        const initials = initialsFromName(emp.name);
        return `
          <button
            type="button"
            id="pending-${emp.id}"
            onclick="window.selectPendingEmployee && window.selectPendingEmployee('${emp.id}')"
            class="pending-card w-full max-w-xs bg-surface-dark rounded-2xl px-4 py-4 border border-white/10 shadow-xl text-left flex items-center gap-3 transform opacity-0 translate-y-4 scale-95 transition-all duration-500 ease-out"
            style="transition-delay: ${idx * 60}ms"
          >
            <div class="h-10 w-10 rounded-full bg-gradient-to-br from-slate-700 to-slate-500 flex items-center justify-center text-xs font-bold text-white uppercase">
              ${initials}
            </div>
            <div class="flex-1 min-w-0">
              <p class="text-sm font-semibold text-white truncate">${emp.name}</p>
              <p class="text-[11px] text-gray-400 uppercase tracking-[0.16em] mt-0.5">
                ID: ${emp.id}
              </p>
            </div>
          </button>
        `;
      }).join("");
    }

    window.selectPendingEmployee = (id) => {
      const emp = REMAINING_EMPLOYEES.find((e) => String(e.id) === String(id));
      if (!emp) return;

      selectedPendingEmployee = emp;

      // Highlight card
      document
        .querySelectorAll(".pending-card")
        .forEach((el) => el.classList.remove("ring-2", "ring-primary", "border-primary/80"));
      const active = document.getElementById(`pending-${emp.id}`);
      if (active) {
        active.classList.add("ring-2", "ring-primary", "border-primary/80");
      }

      // Fill top card
      const nameLabel = document.getElementById("selectedNameLabel");
      const idLabel = document.getElementById("selectedIdLabel");
      const avatar = document.getElementById("selectedAvatar");

      if (nameLabel) nameLabel.textContent = emp.name;
      if (idLabel) idLabel.textContent = `ID: ${emp.id}`;
      if (avatar) avatar.textContent = initialsFromName(emp.name);

      // Fill form fields
      document.getElementById("newId").value = emp.id || "";
      document.getElementById("newMobile").value = emp.mobile || "";
      document.getElementById("newEmail").value = emp.email || "";
      document.getElementById("newIban").value = emp.iban || "";
    };

    function animatePendingOverlayIn() {
      const exec = document.getElementById("execCard");
      if (exec) {
        exec.classList.add("opacity-0", "translate-y-4", "scale-95");
        setTimeout(() => {
          exec.classList.remove("opacity-0", "translate-y-4", "scale-95");
        }, 20);
      }

      setTimeout(() => {
        document.querySelectorAll(".pending-card").forEach((card) => {
          card.classList.remove("opacity-0", "translate-y-4", "scale-95");
        });
      }, 40);
    }

    function markPendingAsUsed(id) {
      const el = document.getElementById(`pending-${id}`);
      if (!el) return;
      el.classList.add("opacity-40", "pointer-events-none");
    }

    // Data
    async function fetchEmployees() {
      const { data, error } = await supabaseClient
        .from("employees")
        .select("*")
        .order("created_at", { ascending: false });

      if (error) {
        showToast("Failed to sync employees");
        employees = [];
        renderEmployees();
        empCount.textContent = "0 Files";
        return;
      }

      employees = data || [];
      renderEmployees();
      empCount.textContent = `${employees.length} Files`;
    }
    window.fetchEmployees = fetchEmployees;

    function renderEmployees() {
      if (!employeesView) return;

      if (!employees.length) {
        employeesView.innerHTML =
          '<div class="col-span-3 text-center text-text-muted py-12 text-sm">No employee files found.</div>';
        return;
      }

      employeesView.innerHTML = employees
        .map(
          (emp) => `
        <button
          type="button"
          onclick="window.openDetailModal && window.openDetailModal('${emp.id}')"
          class="bg-white rounded-xl p-4 flex flex-col gap-2 shadow-sm border border-border-light relative group text-left active:scale-95 transition-all"
        >
          <div class="flex justify-between items-start">
            <div>
              <h3 class="font-bold text-text-main truncate pr-2 text-sm">
                ${emp.name}
              </h3>
              <p class="text-[10px] text-text-muted mt-0.5 font-mono uppercase tracking-wide">
                ID: ${emp.identification_number || ""}
              </p>
            </div>
            <span class="material-symbols-outlined text-gray-300">
              chevron_right
            </span>
          </div>
        </button>
      `
        )
        .join("");
    }

    // Activity logs realtime
    function setupRealtime() {
      if (!activityLogView) return;

      const renderLog = (l) => {
        const div = document.createElement("div");
        div.className = "flex gap-4 group";
        div.innerHTML = `
          <div class="relative shrink-0 flex flex-col items-center">
            <div class="h-10 w-10 rounded-full bg-gray-50 flex items-center justify-center border border-border-light shadow-sm">
              <span class="material-symbols-outlined text-[18px] text-text-muted">
                ${l.action_type === "ADDED" ? "person_add" : l.action_type === "UPDATED" ? "update" : "inventory_2"}
              </span>
            </div>
            <div class="w-[1px] h-full bg-border-light absolute top-10 -bottom-8"></div>
          </div>
          <div class="flex-1 pb-4">
            <div class="flex justify-between items-baseline mb-1">
              <h3 class="text-[14px] font-bold text-text-main">
                ${l.user_email ? l.user_email.split("@")[0] : "User"}
              </h3>
              <span class="text-[10px] font-semibold text-text-muted uppercase tracking-wider">
                ${new Date(l.created_at).toLocaleTimeString()}
              </span>
            </div>
            <p class="text-[13px] text-text-muted leading-relaxed">
              ${l.message || ""}
            </p>
          </div>
        `;
        activityLogView.prepend(div);
      };

      // Initial load
      supabaseClient
        .from("activity_logs")
        .select("*")
        .order("created_at", { ascending: false })
        .limit(5)
        .then(({ data, error }) => {
          if (!error && data) {
            activityLogView.innerHTML = "";
            data.forEach(renderLog);
          }
        });

      // Realtime
      supabaseClient
        .channel("activity_logs")
        .on(
          "postgres_changes",
          { event: "INSERT", schema: "public", table: "activity_logs" },
          (payload) => {
            renderLog(payload.new);
            showToast("New activity");
          }
        )
        .subscribe();
    }

    // Auth
    async function handleLogin() {
      const email = document.getElementById("emailInput").value.trim();
      const password = document.getElementById("passwordInput").value.trim();
      if (!email || !password) {
        showToast("Enter email and password");
        return;
      }

      loginBtn.disabled = true;
      loginBtn.firstElementChild.textContent = "Signing in...";

      const { data, error } = await supabaseClient.auth.signInWithPassword({
        email,
        password
      });

      if (error) {
        showToast(error.message || "Login failed");
        loginBtn.disabled = false;
        loginBtn.firstElementChild.textContent = "Sign In";
        return;
      }

      const user = data.user;
      const { data: roleRow, error: roleError } = await supabaseClient
        .from("user_roles")
        .select("role")
        .eq("user_id", user.id)
        .maybeSingle();

      if (roleError || !roleRow) {
        await supabaseClient.auth.signOut();
        showToast("No role assigned");
        loginBtn.disabled = false;
        loginBtn.firstElementChild.textContent = "Sign In";
        return;
      }

      currentUser = {
        id: user.id,
        email: user.email,
        role: roleRow.role
      };

      const namePart = user.email.split("@")[0];
      currentUserDisplay.textContent = namePart;
      roleBadge.textContent = currentUser.role.toUpperCase();
      if (headerAvatar) headerAvatar.textContent = initialsFromName(namePart);

      // Only creators can open add-screen
      if (currentUser.role === "creator") {
        btnOpenAdd.classList.remove("opacity-40", "pointer-events-none");
      } else {
        btnOpenAdd.classList.add("opacity-40", "pointer-events-none");
      }

      loginScreen.classList.add("hidden");
      mainScreen.classList.remove("hidden");

      await fetchEmployees();
      setupRealtime();

      loginBtn.disabled = false;
      loginBtn.firstElementChild.textContent = "Sign In";
    }

    function handleLogout() {
      askConfirmation("Log Out", "Sign out of Eman Bakery portal?", async () => {
        await supabaseClient.auth.signOut();
        location.reload();
      });
    }

    // Add employee (card overlay)
    function openAdd() {
      addScreen.classList.remove("modal-hidden");
      addScreen.classList.add("modal-visible");

      selectedPendingEmployee = null;

      document.getElementById("newId").value = "";
      document.getElementById("newMobile").value = "";
      document.getElementById("newEmail").value = "";
      document.getElementById("newIban").value = "";

      const nameLabel = document.getElementById("selectedNameLabel");
      const idLabel = document.getElementById("selectedIdLabel");
      const avatar = document.getElementById("selectedAvatar");
      if (nameLabel) nameLabel.textContent = "Tap an employee card below";
      if (idLabel) idLabel.textContent = "ID will appear here";
      if (avatar) avatar.textContent = "--";

      renderPendingCards();
      animatePendingOverlayIn();
    }

    function closeAdd() {
      addScreen.classList.remove("modal-visible");
      addScreen.classList.add("modal-hidden");
    }

    async function handleSaveEmployee() {
      if (!currentUser || currentUser.role !== "creator") {
        showToast("Only creator can add employees");
        return;
      }

      if (!selectedPendingEmployee) {
        showToast("Please tap an employee card");
        return;
      }

      const name = selectedPendingEmployee.name;
      const id = document.getElementById("newId").value.trim();
      if (!name || !id) {
        showToast("Missing ID for selected employee");
        return;
      }

      const mobile = document.getElementById("newMobile").value.trim();
      const email = document.getElementById("newEmail").value.trim();
      const iban = document.getElementById("newIban").value.trim();

      saveEmployeeBtn.disabled = true;
      saveEmployeeBtn.innerHTML = '<div class="loader"></div>';

      const { error } = await supabaseClient.from("employees").insert({
        name,
        identification_number: id,
        mobile,
        email,
        iban,
        qiwa_status: "pending",
        gosi_status: "pending",
        mudad_status: "pending"
      });

      if (error) {
        showToast(error.message || "Error adding employee");
      } else {
        await supabaseClient.from("activity_logs").insert({
          user_email: currentUser.email,
          action_type: "ADDED",
          message: `New profile: ${name}`
        });
        showToast("Employee added");
        markPendingAsUsed(id);
        closeAdd();
        await fetchEmployees();
      }

      saveEmployeeBtn.disabled = false;
      saveEmployeeBtn.innerHTML =
        '<span>Confirm & Submit</span><span class="material-symbols-outlined text-[20px]">check_circle</span>';
    }

    // Init
    (function init() {
      loginBtn.addEventListener("click", handleLogin);
      logoutBtn.addEventListener("click", handleLogout);
      btnOpenAdd.addEventListener("click", openAdd);
      btnCloseAdd.addEventListener("click", closeAdd);
      saveEmployeeBtn.addEventListener("click", handleSaveEmployee);

      // hide loader
      globalLoader.style.display = "none";
    })();
  </script>
</body>
</html>
